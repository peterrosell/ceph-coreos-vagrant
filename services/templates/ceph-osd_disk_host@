[Unit]
Description=Ceph OSD %i - host disk

[Service]
Restart=always
RestartSec=10s
TimeoutStartSec=0
EnvironmentFile=/etc/environment
Environment="DOCKER_REGISTRY=$${DOCKER_REGISTRY}"
Environment="OSD_DISK=host"
ExecStartPre=-/usr/bin/docker pull ${DOCKER_REGISTRY}ceph-osd:latest
ExecStartPre=/bin/sh -c "docker inspect ceph-osd-${OSD_DISK} >/dev/null 2>&1 && docker rm -f ceph-osd-${OSD_DISK} || true"
ExecStart=/usr/bin/docker run --rm --name ceph-osd-${OSD_DISK} --net=host --pid=host --env HOST=${COREOS_PRIVATE_IPV4} --env OSD_DISK=${OSD_DISK} -v /disks/${OSD_DISK}:/var/lib/ceph/osd -v /disk_journal/${OSD_DISK}:/dev/journal ${DOCKER_REGISTRY}ceph-osd:latest
ExecStop=/usr/bin/docker stop ceph-osd-${OSD_DISK}

[X-Fleet]
MachineMetadata="type=storage" "storage=%i" "disk_host=true"
